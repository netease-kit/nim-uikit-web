<!-- 消息气泡组件 -->
<view class="message-bubble-wrapper">
  <!-- 非自己发送的消息 -->
  <view wx:if="{{!msg.isSelf}}" class="msg-container">
    <view wx:if="{{bgVisible}}" class="msg-bg msg-bg-in" bindlongpress="onLongPress">
      <slot></slot>
    </view>
    <view wx:else bindlongpress="onLongPress">
      <slot></slot>
    </view>
  </view>
  
  <!-- 自己发送的消息 -->
  <view wx:else class="msg-container msg-container-self">
    <!-- 发送中状态 -->
    <view wx:if="{{msg.sendingState === 3}}" class="msg-status-wrapper">
      <icon size="21" color="#337EFF" class="msg-status-icon icon-loading" type="icon-a-Frame8" />
      <view wx:if="{{bgVisible}}" class="msg-bg msg-bg-out" bindlongpress="onLongPress">
        <slot></slot>
      </view>
      <view wx:else bindlongpress="onLongPress">
        <slot></slot>
      </view>
    </view>
    
    <view wx:elif="{{msg.sendingState === 2 || (msg.messageStatus && msg.messageStatus.errorCode!==200)}}" class="msg-failed-wrapper">
      <view class="msg-failed" bindtap="onResendMsg">
        <view class="icon-fail">!</view>
        <view wx:if="{{bgVisible}}" class="msg-bg msg-bg-out" bindlongpress="onLongPress">
          <slot></slot>
        </view>
        <view wx:else bindlongpress="onLongPress">
          <slot></slot>
        </view>
      </view>
      <view class="msg-failed-text" wx:if="{{msg.messageStatus && msg.messageStatus.errorCode === 102426}}">对方已将你拉黑，消息发送失败</view>
      <view class="msg-failed-text" wx:elif="{{msg.messageStatus && msg.messageStatus.errorCode === 104404}}">对方已将你删除，消息发送失败</view>
      <view class="msg-failed-text" wx:else>发送失败</view>
    </view>
    
    <!-- 正常状态 -->
    <view wx:else>
      <view wx:if="{{bgVisible}}" class="msg-bg msg-bg-out" bindlongpress="onLongPress">
        <slot></slot>
      </view>
      <view wx:else bindlongpress="onLongPress">
        <slot></slot>
      </view>
    </view>
  </view>
</view>

<!-- 操作菜单 -->
<view wx:if="{{showActionMenu}}" class="action-menu-overlay" bindtap="hideActionMenu">
  <view class="msg-action-groups" style="top: {{menuPosition.top}}px; left: {{menuPosition.left}}px;" catchtap="stopPropagation">
    <!-- 复制 -->
    <view wx:if="{{msg.messageType === 'text'}}" class="msg-action-btn" bindtap="handleCopy">
      <icon size="18" color="#656A72" class="msg-action-btn-icon" type="icon-fuzhi1" />
      <text class="msg-action-btn-text">复制</text>
    </view>
    
    <!-- 回复 -->
    <view wx:if="{{msg.messageType !== 'call'}}" class="msg-action-btn" bindtap="handleReply">
      <icon size="18" color="#656A72" class="msg-action-btn-icon" type="icon-huifu" />
      <text class="msg-action-btn-text">回复</text>
    </view>
    
    <!-- 转发 -->
    <view wx:if="{{msg.messageType !== 'audio' && msg.messageType !== 'call'}}" class="msg-action-btn" bindtap="handleForward">
      <icon size="18" color="#656A72" class="msg-action-btn-icon" type="icon-zhuanfa" />
      <text class="msg-action-btn-text">转发</text>
    </view>
    
    <!-- 撤回 (仅自己的消息) -->
    <view wx:if="{{msg.isSelf && canRecall}}" class="msg-action-btn" bindtap="handleRecall">
      <icon size="18" color="#656A72" class="msg-action-btn-icon" type="icon-chexiao" />
      <text class="msg-action-btn-text">撤回</text>
    </view>
    
    <!-- 删除 -->
    <view class="msg-action-btn" bindtap="handleDelete">
      <icon size="18" color="#656A72" class="msg-action-btn-icon" type="icon-shanchu" />
      <text class="msg-action-btn-text">删除</text>
    </view>
  </view>
</view>